{%- style -%}
    .product-section {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      align-items: center;
      margin: 40px auto;
      max-width: 1400px;
      width: 100%;
    }

    .product-image {
      flex: 1 1 400px;
    }

    .variant-selectors {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .bundle-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    .bundle-option {
      display: flex!important;
      flex-direction: column;
      justify-content: center;
      align-items: initial;
      position: relative;
      box-sizing: border-box;
      cursor: pointer;
      width: 100%;
      margin: 0 0 20px;
      padding: 15px 18px;
      background-color:#fff;
      border-radius: 23px;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .3);
    }

    .bundle-option.active {
      cursor: default;
      background-color: #fff;
      box-shadow: inset 0 0 0 2px #000;
    }
    .bundle-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .bundle-header > input[type='radio'] {
      display: none;
    }
    .bundle-header .custom-radio {
      display: flex;
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      border: 3px solid #fff;
      box-sizing: border-box;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, .3);
    }
    .bundle-option.active .bundle-header .custom-radio {
      background: #000;
      box-shadow: 0 0 0 2px #000;
    }
    .bundle-info {
      flex-grow: 1;
      margin-left: 1rem;
    }
    .bundle-title-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .bundle-subtitle {
      font-size: 0.875rem;
      color: #555;
    }
    .bundle-price {
      text-align: right;
    }
    .price {
      font-weight: bold;
      color: #000;
    }
    .compare {
      text-decoration: line-through;
      color: #999;
      font-size: 0.875rem;
    }
    .popular-wrapper {
      position:absolute;
      top: -10px;
      right: 30px;
    }
    .tag {
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      font-weight: bold;
    }
    .tag.popular {
      margin: 0 8px;
      padding: 6px 8px;
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
      font-family: sans-serif;
      border-radius: 0 0 4px 4px;
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      color: #fff;
      background-color: rgba(83, 129, 37, 1);
      position: relative;
  }

  .tag.popular:before,.tag.popular:after {
      display: block;
      position: absolute;
      top: 0;
      width: 0;
      height: 0;
      content: "";
      border-bottom-width: 8px;
      border-bottom-style: solid;
      filter: brightness(.7);
      border-bottom-color: #3a5a1a;
  }

  .tag.popular:before {
      left: -8px;
      border-left: 8px solid transparent
  }

  .tag.popular:after {
      right: -8px;
      border-right: 8px solid transparent
  }
    .tag.best {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      vertical-align: top;
      padding: 4px 8px;
      word-break: break-word;
      background-color: #912929;
      color: #fff;
      font-size: 12px;
      border-radius: 23px;
    }
    .variant-selectors {
      margin-top: 1rem;
    }
    .variant-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .variant-row > label {
      font-weight: 500;
      color: #333;
    }
    .product-option {
      margin-bottom: 1rem;
    }

    .product-option label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #333;
    }

    .product-option select {
      font-size: 14px;
      font-weight: 400;
      font-style: normal;
      font-family: system-ui;
      -moz-appearance: none;
      -webkit-appearance: none;
      appearance: none;
      border: none;
      padding: 7px 25px 7px 7px;
      margin: 0;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      background-image: url("data:image/svg+xml;utf8,<svg width='10' height='4' viewBox='0 0 10 4' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M5 4L0.669872 0.25L9.33013 0.249999L5 4Z' fill='black'/></svg>")!important;
      background-repeat: no-repeat!important;
      background-position: right 8px center!important;
      background-color: #fff;
      background-size: initial;
      color: #000;
      outline: none;
      min-width: 225px;
      max-width: 100%;
      width: auto;
      height: auto;
      min-height: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .3);
      border-radius: 23px;
    }

    .product-option select:focus , select:not(.disabled):not([disabled]):hover, select:not(.disabled):not([disabled]):focus {
      opacity: 1;
      color: #444;
      background-color: #d2d2d2;
      border-color: #ccc;
      -webkit-box-shadow: 0 0 0 .2rem #b2b2b2;
      -moz-box-shadow: 0 0 0 .2rem #b2b2b2;
      -ms-box-shadow: 0 0 0 .2rem #b2b2b2;
      -o-box-shadow: 0 0 0 .2rem #b2b2b2;
      box-shadow: 0 0 0 .2rem #b2b2b2;
    }

    .add-to-cart {
      background: #2e7d32;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      font-size: 1rem;
    }
{%- endstyle -%}

<div class="product-section">
  <div class="product-image">
    <div class="main-image">
      <img id="currentImage" src="{{ product.featured_image | img_url: 'master' }}" alt="{{ product.title }}">
    </div>
  </div>
  <div class="product-content">
    <div class="bundle-selector">
      <h3 class="bundle-title">- Bundle promotion is valid till 11:59 PM -</h3>

      {% assign base_price = product.price %}
      {% assign compare_price = product.compare_at_price %}
      {% assign discounts = '0,0.10,0.15' | split: ',' %}
      {% assign labels = 'Standard Price,10% extra discount on the total order!,15% extra discount on the total order!'
        | split: ','
      %}

      {% for i in (1..3) %}
        {% assign discount = discounts[i-1] | times: 1.0 %}
        {% assign total_price = base_price | times: i %}
        {% assign discount_amount = total_price | times: discount %}
        {% assign discounted_price = total_price | minus: discount_amount %}
        {% assign label = labels[i-1] %}

        <div class="bundle-option {% if i == 1 %}active{% endif %}" data-tier="{{ i }}">
          <label class="bundle-header">
            <input
              type="radio"
              name="bundle_option"
              value="{{ i }}"
              {% if i == 1 %}
                checked
              {% endif %}
            >
            <div class="custom-radio"></div>

            <div class="bundle-info">
              <div class="bundle-title-row">
                <strong>{{ i }} Pair</strong>

                {% if i == 2 %}
                  <div class="tag-wrapper popular-wrapper">
                    <span class="tag popular">MOST POPULAR!</span>
                  </div>
                {% elsif i == 3 %}
                  <div class="tag-wrapper best-wrapper">
                    <span class="tag best">BEST DEAL</span>
                  </div>
                {% endif %}
              </div>

              <div class="bundle-subtitle">{{ label }}</div>
            </div>

            <div class="bundle-price">
              <span class="price">Tk {{ discounted_price | money }}</span>
              <span class="compare">Tk {{ compare_price | times: i | money }}</span>
            </div>
          </label>

          <div class="variant-selectors">
            <div class="variant-inner">
              {% for j in (1..i) %}
                <div class="variant-row">
                  <label>#{{ j }}</label>
                  <div>
                    {% for option in product.options_with_values %}
                      <div class="product-option">
                        <label for="option-{{ forloop.index0 }}">{{ option.name }}</label>
                        <select
                          id="option-{{ forloop.index0 }}"
                          name="options[{{ option.name }}]"
                          data-option-index="{{ forloop.index0 }}"
                        >
                          {% for value in option.values %}
                            <option
                              value="{{ value | escape }}"
                              {% if value == option.selected_value %}
                                selected
                              {% endif %}
                            >
                              {{ value | escape }}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endfor %}

      <button class="add-to-cart">ðŸ›’ Add to cart</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    function updateBundleAccordion(selectedTier) {
      document.querySelectorAll('.bundle-option').forEach((option) => {
        const tier = parseInt(option.dataset.tier);
        const container = option.querySelector('.variant-selectors');

        if (tier === selectedTier) {
          option.classList.add('active');
          container.style.maxHeight = container.scrollHeight + 'px';
        } else {
          option.classList.remove('active');
          container.style.maxHeight = '0px';
        }
      });
    }

    // Initial load: expand the pre-selected tier
    const defaultSelected = document.querySelector('input[name="bundle_option"]:checked');
    if (defaultSelected) {
      updateBundleAccordion(parseInt(defaultSelected.value));
    }

    // On change: update accordion
    document.querySelectorAll('input[name="bundle_option"]').forEach((radio) => {
      radio.addEventListener('change', (e) => {
        updateBundleAccordion(parseInt(e.target.value));
      });
    });

    // =======================
    // AJAX Add to Cart logic
    // =======================
    const addToCartBtn = document.querySelector('.add-to-cart');

    addToCartBtn.addEventListener('click', function () {
      addToCartBtn.disabled = true;
      addToCartBtn.innerText = "Adding...";

      // à¦¯à§‡à¦‡ bundle active à¦†à¦›à§‡, à¦¸à§‡à¦‡à¦Ÿà¦¾ à¦¨à¦¾à¦“
      const activeBundle = document.querySelector('.bundle-option.active');
      const qty = parseInt(activeBundle.dataset.tier);

      let formData = {
        items: []
      };

      // à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ variant-row à¦¥à§‡à¦•à§‡ à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿà§‡à¦¡ à¦…à¦ªà¦¶à¦¨ à¦¨à¦¿à§Ÿà§‡ à¦¨à¦¾à¦“
      activeBundle.querySelectorAll('.variant-row').forEach((row) => {
        let properties = {};
        row.querySelectorAll('select').forEach((select) => {
          properties[select.name] = select.value;
        });

        formData.items.push({
          id: {{ product.variants.first.id }}, // à¦à¦–à¦¾à¦¨à§‡ à¦¡à¦¿à¦«à¦²à§à¦Ÿ variant id à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦›à¦¿
          quantity: 1,
          properties: properties
        });
      });

      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(formData)
      })
        .then((res) => res.json())
        .then((data) => {
          console.log("Added to cart:", data);
          addToCartBtn.innerText = "âœ” Added!";
          addToCartBtn.style.background = "#388e3c";

          setTimeout(() => {
            addToCartBtn.innerText = "ðŸ›’ Add to cart";
            addToCartBtn.disabled = false;
          }, 2000);

          // à¦šà¦¾à¦‡à¦²à§‡ mini-cart à¦¬à¦¾ cart drawer à¦–à§à¦²à¦¤à§‡ à¦ªà¦¾à¦°à§‹
          // window.location.href = "/cart";
        })
        .catch((err) => {
          console.error("Error:", err);
          addToCartBtn.innerText = "Error!";
          addToCartBtn.disabled = false;
        });
    });
  });
</script>
