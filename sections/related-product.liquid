<div
  class="product-recommendations"
  data-url="{{ routes.product_recommendations_url }}?section_id=related-product&product_id={{ product.id }}&limit=4&intent=related"
>

  {% if recommendations.performed and recommendations.products_count > 0 %}
    <h2 class="text-xl font-bold mb-4">
      {% if recommendations.intent == 'related' %}
        Related Products
      {% elsif recommendations.intent == 'complementary' %}
        Pair it with
      {% endif %}
    </h2>

    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
      {% for product in recommendations.products %}
        <div>
          {% render 'product-card', product: product %}
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const section = document.querySelector('.product-recommendations');
    if (!section) return;

    const url = section.dataset.url;
    if (!url) return;

    const observer = new IntersectionObserver((entries, observer) => {
      if (!entries[0].isIntersecting) return;
      observer.unobserve(section);

      fetch(url)
        .then(res => res.text())
        .then(html => {
          const temp = document.createElement('div');
          temp.innerHTML = html;

          const inner = temp.querySelector('.product-recommendations');
          if (inner && inner.innerHTML.trim()) {
            section.innerHTML = inner.innerHTML;
          } else {
            section.remove(); // Remove if no products
          }
        })
        .catch(err => {
          console.error('Error loading recommendations:', err);
        });
    }, {
      rootMargin: '0px 0px 200px 0px'
    });

    observer.observe(section);
  });
</script>

{% schema %}
{
  "name": "Related Product",
  "tag": "section",
  "settings": [],
  "presets": [
    {
      "name": "Related Product",
      "category": "Product"
    }
  ]
}
{% endschema %}
